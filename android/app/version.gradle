import java.util.regex.Matcher
import java.util.regex.Pattern

ext {
    /**
     * Reads version from Git tag and generates Android version code
     */
    getVersionDetails = { ->
        def stdout = new ByteArrayOutputStream()
        exec {
            commandLine 'git', 'describe', '--tags', '--match', 'v[0-9]*.[0-9]*.[0-9]*'
            standardOutput = stdout
        }
        def version = stdout.toString().trim()
        
        // Parse version components
        Pattern pattern = Pattern.compile("v(\\d+)\\.(\\d+)\\.(\\d+)")
        Matcher matcher = pattern.matcher(version)
        
        if (matcher.find()) {
            def major = matcher.group(1) as int
            def minor = matcher.group(2) as int 
            def patch = matcher.group(3) as int

            // Generate Android version code
            def versionCode = major * 10000 + minor * 100 + patch
            
            return [
                versionCode: versionCode,
                versionName: "${major}.${minor}.${patch}"
            ]
        }
        
        return [
            versionCode: 1,
            versionName: "1.0.0" 
        ]
    }
}